# ESP32 Bluetooth колонка на MAX98357 (ESP32-A2DP)

Проект: простая Bluetooth‑колонка на базе **ESP32** (classic, WROOM) и I2S‑усилителя **MAX98357A**.
Аудио принимается по **Bluetooth A2DP** (телефон / ПК) и выводится через I2S на MAX98357.

Используется библиотека:
https://github.com/pschatzmann/ESP32-A2DP

---

## Аппаратная часть

**Плата:**
- Любой **ESP32** с Bluetooth Classic (НЕ C3/C2/C6, НЕ S3‑варианты).
  - Примеры: ESP32 DevKit, ESP32 WROOM Dev Board, D1 mini ESP32 (classic).

**Аудио‑усилитель:**
- Модуль **MAX98357A** (I2S‑цифровой усилитель).

**Подключение MAX98357 ↔ ESP32**

Пины в скетче `BT_transiver.ino`:

- I2S:
  - `GPIO 26` → `BCLK` (`BCK`) на MAX98357  
  - `GPIO 25` → `LRCLK` (`LRC`, `WSEL`) на MAX98357  
  - `GPIO 22` → `DIN` (`SDATA`) на MAX98357  

- Питание:
  - `5V` ESP32 → `VIN` MAX98357 (если модуль рассчитан на 5 В)  
  - `GND` ESP32 → `GND` MAX98357  

- Прочие выводы (если есть на модуле):
  - `SD` (shutdown) → 3.3V (усилитель всегда включён)  
  - `GAIN` можно оставить не подключённым или задать по даташиту (уровень усиления).

- Динамик:
  - `SPK+` / `OUT+` и `SPK-` / `OUT-` → на выводы динамика (не сажать на GND).

---

## Программная часть

### Зависимости

1. **Arduino IDE** с установленной поддержкой плат ESP32:
   - через Board Manager:
     - URL ядра ESP32 от Espressif,
     - установка плат **ESP32 by Espressif Systems**.

2. Библиотека **ESP32-A2DP**:  
   https://github.com/pschatzmann/ESP32-A2DP  
   - установить через **Sketch → Include Library → Add .ZIP Library**  
     или склонировать в `Documents/Arduino/libraries/ESP32-A2DP`.

### Логика скетча

Файл `BT_transiver.ino` делает следующее:

- Подключает `BluetoothA2DPSink` и `driver/i2s.h`.
- Инициализирует I2S0 с параметрами:
  - 44.1 kHz, 16 бит, стерео, стандартный Philips I2S.
- Настраивает пины I2S:
  - BCLK=GPIO 26, LRCLK=GPIO 25, DATA=GPIO 22.
- Регистрирует `set_stream_reader(audio_callback, false)`:
  - библиотека декодирует A2DP‑аудио (SBC) и передаёт PCM‑буферы в `audio_callback`.
  - флаг `false` отключает внутренний I2S‑вывод библиотеки.
- В `audio_callback` данные сразу отправляются в I2S через `i2s_write`.
- Стартует A2DP Sink с именем устройства `ESP32_BT_SPEAKER`.

Телефон/ПК видит ESP32 как обычную Bluetooth‑колонку.

---

## Сборка и прошивка

1. Открыть `BT_transiver.ino` в Arduino IDE.
2. В **Инструменты → Плата** выбрать подходящую плату ESP32:
   - например, `ESP32 Dev Module` или конкретный профиль вашей платы.
3. Выбрать COM‑порт ESP32.
4. Нажать **Загрузить** (Upload).

После прошивки открыть **Serial Monitor** (115200) — будут видны логи Bluetooth/I2S.

---

## Использование

1. Включить питание ESP32 и MAX98357.
2. Включить Bluetooth на телефоне / ПК.
3. Найти устройство:
   - `ESP32_BT_SPEAKER`
4. Подключиться (пейринг).
5. Запустить музыку (Spotify, YouTube, плеер и т.д.).
6. Звук идёт через динамик, подключённый к MAX98357.

---

## Нюансы и ограничения

- **Тип ESP32:**
  - Нужен **классический ESP32 с Bluetooth Classic**.
  - Модули на **ESP32‑C3, ESP32‑S3, ESP32‑C2, ESP32‑C6** имеют только BLE (Bluetooth LE) и **не поддерживают A2DP** → с ними `ESP32-A2DP` как колонка работать не будет.

- **Кодеки:**
  - Стандартная связка ESP32‑A2DP использует **SBC** (обязательный кодек A2DP).
  - AAC / aptX / aptX HD / LDAC в типичной Arduino‑сборке не используются и не управляются из скетча.

- **Watchdog / зависания:**
  - При неправильной настройке/подключении I2S возможны зависания (`task_wdt`).
  - В этом проекте вывод аудио реализован **явным `i2s_write` в `audio_callback`**, а внутренний I2S‑вывод ESP32‑A2DP отключён.

- **Питание и шумы:**
  - MAX98357 чувствителен к качеству питания.
  - Для чистого звука желательно сглаживание по питанию, аккуратная земля и короткие провода к динамику.

---

## Стерео на 2× MAX98357A

ESP32 по I2S уже выдаёт стерео (левый+правый канал). Чтобы получить полноценное стерео на двух модулях MAX98357A, достаточно правильно использовать пин `SD`.

### Режимы MAX98357A по пину SD

У MAX98357A пин `SD` выполняет двойную функцию (канал + выключение):

- `SD = LOW` (жёстко на GND) → модуль работает как **левый канал**: пропускает только те сэмплы, когда `LRC = LOW`.
- `SD = HIGH` (жёстко на VIN, +5 В или +3.3 В, в зависимости от питания модуля) → модуль работает как **правый канал**: пропускает только те сэмплы, когда `LRC = HIGH`.
- `SD` не подключён (плавающий) → модуль в режиме **shutdown**, выход отключён.

Это полностью аппаратная функция внутри MAX98357A, дополнительных настроек в коде не требуется.

### Подключение для стерео

Оба модуля получают одинаковый I2S‑сигнал от ESP32:

- `GPIO 26` → `BCLK` (`BCK`) обоих модулей MAX98357A.
- `GPIO 25` → `LRCLK` (`LRC`, `WSEL`) обоих модулей.
- `GPIO 22` → `DIN` (`SDATA`) обоих модулей.
- `VIN` и `GND` — общие для обоих модулей (от ESP32/БП).

Отличия только по пину `SD`:

- **Модуль №1 (левый динамик)**: `SD` жёстко подтянут к **GND** → левый канал.
- **Модуль №2 (правый динамик)**: `SD` жёстко подтянут к **VIN** → правый канал.

Выводы динамиков:

- Модуль №1 → левый динамик (`SPK+/OUT+` и `SPK-/OUT-`).
- Модуль №2 → правый динамик.

`GAIN` на каждом модуле настраивается отдельно (можно одинаково на обоих по даташиту, чтобы каналы звучали с одинаковой громкостью).

Код `BT_transiver.ino` при этом менять не требуется: I2S уже настроен как стерео, а PCM‑данные передаются в `i2s_write` без изменений.

## Ссылки

- ESP32‑A2DP (Phil Schatzmann):  
  https://github.com/pschatzmann/ESP32-A2DP  
- Документация ESP32‑A2DP / примеры:  
  https://github.com/pschatzmann/ESP32-A2DP?tab=readme-ov-file
- Даташит MAX98357A: искать по запросу *MAX98357A datasheet*.
